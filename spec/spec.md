<!-- Формат сообщений сервера: -->

<!-- Флоу клиента: -->

# Спецификация websocket протокола

### Словарь:

- `kind` - типы сообщений:
    - посылаемые сервером:
        - `game-start` - начало игры.
        - `waiting-player-turn` - ожидание хода игрока (идентификация игрока производится сервером на основании websocket коннекта)
        - `cell-occupied` - посылается если клиент послал сообщение `make-turn` содержащее индекс ячейки, которая **занята**.
        - `game-finished` - окончание игры с её результатом.
    - посылаемые клиентом:
        - `set-player-data` - пока не используется.
        - `play-ready` - готовность игрока к игре.
        - `make-turn` - сообщение, содержащее индекс ячейки, куда необходимо поставить марку

- `марка/mark` - знак `x`/`o` присваиваемый игрокам.
- `grid` - игровое поле 3x3. Представлено в виде одномерного массива с типами `int`.

## Flow игры

После начала игры клиентам необходимо обмениваться сообщениями с `ws server'ом` содержащими индексы ячеек, куда был сделан ход. Игра продолжается до тех пор, пока:
- не появился один победитель - `x`/ `o`.
- один из игроков не покинул игру.
- игра не завершилась ничьей (draw).  

---

1. Клиент коннектится к `ws server` (websocket server).
2. По готовности игрока к игре необходимо послать сообщение `play-ready` на `ws server` формата:

```json
{
    "kind":"play-ready"
}
```

После отправки данного сообщения `ws server` поместит игрока в поиск игры. Игра начнется, после нахождения второго игрока.

3. После формирования игры `ws server'ом` клиенту будет послано сообщение `game-start` вида:

```json
{
    "kind":"game-start",
    "data":{
        "first_turn":true,
        "game_id":"some-game-id",
        "mark":"x",
    }
}
```

- `first_turn`: bool - ходит ли игрок первым.
- `game_id`: строка - идентификатор игры.
- `mark`: строка - марка игрока. Значения: `x`, `o`.

4.1. Если в `п.3` - `first_turn: true`  
Игрок ходит первым - после хода игрока клиенту необходимо послать сообщение на `ws server` вида:

```json
{
    "kind":"make-turn",
    "data":{
        "cell_index":0,
        "game_id":"some-game-id"
    }
}
```

- `cell_index`: int, возможные значения: 0-8. Индекс ячейки в которую необходимо поставить марку. Поле представляет собой одномерный массив с индексами \[0-8\].
- `game_id`: строка - идентификатор игры полученный из сообщения `play-ready`,

4.2. Если в п.3 `first_turn: false`  
Игрок ходит второй. Клиент ждет результат хода первого игрока сообщение `waiting-player-turn`.

5. После совершения хода игрока `ws server` посылает сообщение `waiting-player-turn` другому игроку, от которого ожидается ход, формат сообщения:

```json
{
    "kind":"waiting-player-turn",
    "data":{
        "game_id":"some-game-id",
        "game_grid":["x","-","-","-","-","-","-","-","-"]
    }
}
```

- `game_grid` - состояние игровой доски. Массив строк формата: `["-","-","-","-","-","-","-","-","-"]`. Возможное значение строк:
    - `-` - клетка пустая
    - `x` - клетка занята маркой - `x`
    - `o` - клетка занята маркой - `o`

6. По завершению игры `ws server` посылает сообщение `game-finished` с результатом игры, формат сообщения:

```json
{
    "kind":"game-finished",
    "data":{
        "game_id":"some-game-id",
        "player_won":true,
        "is_draw":false,
        "opponent_disconnect":false,
        "game_grid":["x","x","x","-","-","-","-","-","-"],
    }
}
```

- `game_id`: строка - идентификатор завершенной игры
- `player_won`: bool - флаг выйграл ли игрок или нет
- `is_draw`: bool - флаг закончилась ли игра ничьей
- `opponent_disconnect`: bool - флаг вышел ли опонент из игры
- `game_grid`: массив строк - состояние игровой доски